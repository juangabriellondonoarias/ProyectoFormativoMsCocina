version: '3.8'

services:
  # ----------------------------------------------------
  # Servicio de la Base de Datos MySQL (ms_cocina_mysql_db)
  # ----------------------------------------------------
  mysql-db:
    image: mysql:8.0
    container_name: ms_cocina_mysql_db
    environment:
      # Credenciales de la base de datos (Usuario root y contraseña)
      MYSQL_ROOT_PASSWORD: Carlos2515.
      MYSQL_DATABASE: Modulo_Cocina
    ports:
      # Mapeo del puerto para acceso externo (opcional, si necesitas conectarte desde tu máquina)
      - "3307:3306"
    volumes:
      # Persistencia de datos
      - mysql_data:/var/lib/mysql

  # ----------------------------------------------------
  # Servicio de la Aplicación Spring Boot (ms_cocina_app)
  # ----------------------------------------------------
  ms_cocina:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ms_cocina_app
    ports:
      # Mapeo del puerto de la aplicación
      - "8085:8085"
    depends_on:
      - mysql-db # Asegura que la DB se inicie primero
    environment:
      # **¡CONFIGURACIÓN CORREGIDA DE LA BASE DE DATOS!**
      # 1. URL con la opción 'allowPublicKeyRetrieval=true' (para evitar el error de clave pública)
      # 2. El host es 'mysql-db' (el nombre del servicio de Docker Compose)
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-db:3306/Modulo_Cocina?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true

      # 3. Usuario (Importante para evitar el error 'Access denied (using password: NO)')
      SPRING_DATASOURCE_USERNAME: root

      # 4. Contraseña (Importante para evitar el error 'Access denied (using password: NO)')
      SPRING_DATASOURCE_PASSWORD: Carlos2515.

    restart: always

# Volúmenes para persistencia de datos de MySQL
volumes:
  mysql_data: